<!DOCTYPE html>
<html>
  <head>
    <title>Prices Cars</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.9.0/lodash.min.js"></script>
    <script src="build/react.js"></script>
    <script src="build/JSXTransformer.js"></script>
    <script src="https://cdn.firebase.com/js/client/1.0.17/firebase.js"></script>
    <script src="https://cdn.firebase.com/libs/reactfire/0.1.6/reactfire.min.js"></script>
  </head>
  <body>
    <div id="example"></div>
    <script type="text/jsx">
      var SearchCar = React.createClass({
        handleChange: function(){
          this.props.userInput(this.refs.filterTextNode.getDOMNode().value);
        },
        render: function(){
          return (
            <form>
              <input type="text" placeholder="Search..." value={this.props.filterText} ref="filterTextNode" onChange={this.handleChange} />
            </form>
          );
        }
      });

      var FilterCar = React.createClass({
        handleChange: function(){
          var hash = {};
          hash[this.props.fieldName] = this.refs.filterOptionNode.getDOMNode().value;
          this.props.userInput(hash);
        },
        render: function(){
          var h = {};
          h[this.props.fieldName] = _.uniq(this.props.cars.map(function(car){
            return car[this.props.fieldName];
          }.bind(this)));
          var options = h[this.props.fieldName].map(function(item){
            return (<option>{item}</option>);
          });
          return (
            <select onChange={this.handleChange} ref="filterOptionNode">
              <option value="">Select one...</option>
              {options}
            </select>
          );
        }
      });

      var Car = React.createClass({
        render: function(){
          return (
            <div className="car-item">
              <span>{this.props.brand}</span>  
              <h3>{this.props.model}</h3>
              <p>{this.props.year} - {this.props.price}</p>
            </div>
          );
        }
      });

      var CarList = React.createClass({
        render: function(){
          var car_nodes = this.props.cars.map(function(car){
            if (car.brand.indexOf(this.props.filterText) === -1 && car.model.indexOf(this.props.filterText) === -1) return;
            if(this.props.filterBrand && car.brand != this.props.filterBrand) return;
            if(this.props.filterModel && car.model != this.props.filterModel) return;
            return (
              <Car brand={car.brand} model={car.model} year={car.year} price={car.price} ></Car>
            );
          }.bind(this));
          return (
            <div className="car-list">
              <h1>List of Cars</h1>
              {car_nodes}
            </div>
          );
        }
      });

      var FilterableCar = React.createClass({
        mixins: [ReactFireMixin],
        getInitialState: function(){
          return {cars: [], filterText: ''};
        },
        componentWillMount: function(){
          this.bindAsArray(new Firebase("https://prices-cars.firebaseio.com/cars/"), "cars");
        },
        handleChangeSearch: function(keyword){
          this.setState({filterText: keyword});
        },
        handleChangeFilter: function(state){
          this.setState(state);
        },
        render: function(){
          return (
            <div>
              <SearchCar filterText={this.state.filterText}
              userInput={this.handleChangeSearch} />
              <FilterCar fieldName="brand" userInput={this.handleChangeFilter} cars={this.state.cars} />
              <FilterCar fieldName="model" userInput={this.handleChangeFilter} cars={this.state.cars} />
              <CarList filterText={this.state.filterText} filterBrand={this.state.brand} filterModel={this.state.model} cars={this.state.cars}/>
            </div>
          );
        }
      });

      React.render(
        <FilterableCar/>,
        document.getElementById('example')
      );
    </script>
  </body>
</html>